# Документация: Реализация функционала согласия пользователя

## Задача
Добавить функциональность принятия соглашения пользователем перед началом работы с ботом. После команды `/start` и до основного меню бот должен отправлять сообщение с требованием принять соглашения. Пока пользователь не нажал "Согласен", бот должен игнорировать все команды. В базе данных должны храниться дата принятия согласия и версия соглашения.

## Выполненные изменения

### 1. Модель базы данных (db/models.py)
Добавлены поля в модель `User`:
- `terms_accepted` (Boolean, nullable=True, default=False) - флаг принятия согласия
- `terms_accepted_at` (DateTime, nullable=True) - дата и время принятия согласия
- `terms_version` (String, nullable=True) - версия соглашения

### 2. Миграция базы данных (db/migrator.py)
Создана миграция `0004_add_terms_acceptance_fields`:
- Добавляет колонки `terms_accepted`, `terms_accepted_at`, `terms_version` в таблицу `users`
- Миграция проверяет существование колонок перед добавлением, что делает её безопасной для повторного запуска

### 3. Настройки (config/settings.py)
Добавлены новые настройки:
- `TERMS_DOCUMENTS_URL` (Optional[str]) - URL на документы с соглашениями
- `TERMS_VERSION` (str, default="1.0") - версия соглашения

### 4. Middleware (bot/middlewares/terms_acceptance_middleware.py)
Создан новый middleware `TermsAcceptanceMiddleware`, который:
- Проверяет, принял ли пользователь согласие перед обработкой любой команды
- Разрешает обработку команды `/start` (для показа сообщения о согласии)
- Разрешает обработку callback-запросов, связанных с согласием (`terms:accept`, `terms:decline`)
- Пропускает администраторов (они не обязаны принимать согласие)
- Блокирует все остальные команды до принятия согласия
- Показывает сообщение о необходимости принять согласие с кнопками

### 5. Обработчик команды /start (bot/handlers/user/start.py)
Изменен обработчик `/start`:
- После проверки подписки на канал проверяется, принял ли пользователь согласие
- Если согласие не принято, показывается сообщение с кнопками согласия вместо основного меню
- Добавлены обработчики callback-запросов:
  - `terms:accept` - сохраняет согласие в БД (устанавливает `terms_accepted=True`, `terms_accepted_at=now`, `terms_version=settings.TERMS_VERSION`)
  - `terms:decline` - показывает сообщение об отказе

### 6. Клавиатура (bot/keyboards/inline/user_keyboards.py)
Добавлена функция `get_terms_acceptance_keyboard`:
- Создает клавиатуру с кнопками:
  - "Согласен" (callback_data="terms:accept")
  - "Открыть документы" (URL кнопка, если указан TERMS_DOCUMENTS_URL)
  - "Отказаться" (callback_data="terms:decline")

### 7. Локализация (locales/ru.json, locales/en.json)
Добавлены ключи локализации:
- `terms_acceptance_required` - текст сообщения о необходимости принять согласие
- `terms_accept_button` - текст кнопки "Согласен"
- `terms_open_documents_button` - текст кнопки "Открыть документы"
- `terms_decline_button` - текст кнопки "Отказаться"
- `terms_accepted_success` - сообщение об успешном принятии согласия
- `terms_declined_message` - сообщение об отказе от принятия согласия

### 8. Регистрация middleware (bot/app/controllers/dispatcher_controller.py)
Добавлен `TermsAcceptanceMiddleware` в цепочку middleware:
- Установлен после `ChannelSubscriptionMiddleware` и перед `ActionLoggerMiddleware`
- Это гарантирует, что проверка согласия происходит после проверки подписки на канал

## Работа функционала

### Сценарий 1: Новый пользователь
1. Пользователь запускает бота командой `/start`
2. Бот создает пользователя в БД с `terms_accepted=False`
3. После проверки подписки на канал (если требуется) показывается сообщение о согласии
4. Пользователь должен нажать "Согласен" для продолжения
5. После принятия согласия показывается приветственное сообщение и основное меню

### Сценарий 2: Пользователь без принятого согласия
1. Пользователь пытается использовать любую команду (кроме `/start`)
2. Middleware блокирует команду и показывает сообщение о необходимости принять согласие
3. Пользователь может нажать `/start` для просмотра сообщения о согласии
4. После принятия согласия пользователь может использовать бот

### Сценарий 3: Пользователь нажимает "Отказаться"
1. Пользователь видит сообщение об отказе
2. Бот продолжает блокировать команды до принятия согласия
3. Пользователь может снова нажать `/start` для просмотра сообщения о согласии

### Сценарий 4: Администратор
1. Администраторы автоматически пропускают проверку согласия
2. Они могут использовать бот без принятия согласия

## Настройка

Для настройки функционала необходимо добавить в `.env` файл:

```env
# Версия соглашения (по умолчанию "1.0")
TERMS_VERSION=1.0

# URL на документы с соглашениями (опционально)
TERMS_DOCUMENTS_URL=https://example.com/terms
```

## База данных

После применения миграции в таблице `users` будут добавлены следующие колонки:
- `terms_accepted` - флаг принятия согласия (по умолчанию `False`)
- `terms_accepted_at` - дата и время принятия согласия (NULL, если не принято)
- `terms_version` - версия соглашения (NULL, если не принято)

## Важные замечания

1. **Версия соглашения**: При изменении версии соглашения существующие пользователи с принятым согласием не будут автоматически уведомлены. При необходимости можно добавить функционал для проверки версии соглашения и повторного запроса согласия.

2. **Миграция**: Миграция автоматически применяется при запуске бота. Убедитесь, что база данных доступна и права доступа настроены корректно.

3. **Администраторы**: Администраторы (указанные в `ADMIN_IDS`) автоматически пропускают проверку согласия.

4. **Обратная совместимость**: Для существующих пользователей `terms_accepted` будет `NULL` (что трактуется как `False`), поэтому они будут обязаны принять согласие при следующем использовании бота.

## Тестирование

Для тестирования функционала:
1. Создайте нового пользователя или удалите запись о принятии согласия в БД
2. Запустите бота командой `/start`
3. Убедитесь, что показывается сообщение о согласии
4. Нажмите "Согласен" и убедитесь, что показывается основное меню
5. Попробуйте использовать другие команды - они должны работать
6. Установите `terms_accepted=False` в БД и попробуйте использовать команды - они должны блокироваться

## Заключение

Функционал принятия согласия успешно реализован. Пользователи обязаны принять согласие перед использованием бота. Дата принятия согласия и версия соглашения сохраняются в базе данных для учета и аудита.

